<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="https://gustavosilva.me//blog/feed.xml" rel="self" type="application/atom+xml" /><link href="https://gustavosilva.me//blog/" rel="alternate" type="text/html" /><updated>2020-07-03T00:06:36+00:00</updated><id>https://gustavosilva.me//blog/feed.xml</id><title type="html">Gustavo Silva’s Blog</title><subtitle>My personal blog!</subtitle><entry><title type="html">How I hacked Anda, the public transportation app of Porto (CVE-2018-13342)</title><link href="https://gustavosilva.me//blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html" rel="alternate" type="text/html" title="How I hacked Anda, the public transportation app of Porto (CVE-2018-13342)" /><published>2018-10-23T00:00:00+00:00</published><updated>2018-10-23T00:00:00+00:00</updated><id>https://gustavosilva.me//blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342</id><content type="html" xml:base="https://gustavosilva.me//blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html">&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Andante is the multimodal transport ticket used in the city of Porto. On the 28th July 2018, the company behind Andante released the Anda app to allow the users of their public transport system to no longer need a physical card as ticket. Instead, by taking advantage of the GPS, NFC and BLE capabilities of modern smartphones, passengers now only need their mobile phones to travel.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I decided to observe the network packets sent by Anda to understand which kind of requests it was making to its API. Fot that, I used a packet sniffer app that acts as man-in-the-middle listening to all packets in both directions. Since all communications of Anda are performed using HTTPS, the packet sniffer uses a custom certificate for which it has both the public and private keys. Soon I realized this did not work, because Anda was programmed to perform certificate pinning, that is, being limited to a pre-defined certificate and not accepting others. One solution for this is to change the Anda app so that it allows a different certificate to be used. However, sometimes tweaking with the application code to bypass certificate pinning is not enough, if other protection mechanisms are implemented.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Instead of trying to obtain readable access to the network packets sent by Anda, I decided to decompile the .apk file and analyze the Java code to understand how it was communicating with the server API.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The application code was slightly obfuscated. Some of the methods were not implemented in Java but imported as a compiled native library with Java Native Interface (JNI). These methods were:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;loadNative() - initialization of the JNI environment.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;verifyBeacon(byte[] b1, byte[] b2, int n) - did not investigate what this method does, probably related to BLE beacons.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;getServerInfo() - returns an array with 3 hard-coded strings that were obfuscated in the compiled library: the base URL of the API, a username and a password.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;getPersonalEncryptionkey() - returns a key based on the ANDROID_ID of the device.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In order to better understand the output of each of these functions, I analyzed the decompiled code of Anda and created a small Android application calling them in a similar manner and logging their output. This was the code of my app:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;System.loadLibrary(&quot;native-lib&quot;);

boolean resultA = initializeNative();
Log.d(&quot;ANDA-DEBUG&quot;, resultA ? &quot;true&quot; : &quot;false&quot;);

boolean resultB = verifyBeacon(&quot;&quot;.getBytes(), &quot;&quot;.getBytes(), 1);
Log.d(&quot;ANDA-DEBUG&quot;, resultB ? &quot;true&quot; : &quot;false&quot;);

String[] resultC = getServerInfo();
for (String s : resultC) {
    Log.d(&quot;ANDA-DEBUG&quot;, s + &quot;&quot;);
}

String resultD = getPersonalEncryptionPass();
Log.d(&quot;ANDA-DEBUG&quot;, resultD + &quot;&quot;);&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This attempt was not successful, as the first two functions returned &quot;false&quot; and the other two returned null values. Something was blocking my app from properly using the methods defined in the native library file.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;disassembling&quot;&gt;Disassembling&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So I opened a disassembler and searched for what was causing this behavior. I noticed that all 4 functions made a call to another function named &quot;isInitialized&quot;, immediately branching when false to a return statement with a zeroed return value. I figured this would most likely be the cause of the &quot;false&quot; and &quot;null&quot; outputs (zero, false and null are often represented the same way in machine code). Therefore, I had to understand why the &quot;loadNative&quot; method was not correctly initializing the JNI environment.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Looking at the initialization instructions, I found that it was getting the signature of my application and comparing it with a pre-defined value to detect tampering. If the signatures did not match, then the program would branch to the end and return 0. This was done with the CBZ instruction (Compare and Branch on Zero).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;title&quot;&gt;Excert of the disassembled libnative library&lt;/div&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;&lt;code class=&quot;language-asm&quot; data-lang=&quot;asm&quot;&gt;BLX  __aeabi_memclr8
ADD  R6, SP, #0xF0+var_C4
MOV  R0, R6
BLX  j_sha256_init
MOV  R0, R6
MOV  R1, R8
MOV  R2, R5
BLX  j_sha256_update
MOV  R0, R6
MOV  R1, R10
BLX  j_sha256_final
LDR  R1, =(unk_13B13 - 0x3AF4)
MOV  R0, R10
MOVS R2, #0x20
ADD  R1, PC
BLX  memcmp &lt;b class=&quot;conum&quot;&gt;(1)&lt;/b&gt;
CBZ  R0, loc_3B24&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;colist arabic&quot;&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;'memcmp': function of the C library that compares two regions of memory of the same size and returns 0 if they are equal&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In order to make my app bypass this verification, I patched the binary code so that the CBZ instruction was replaced by a CBNZ (Compare and Branch on Non-Zero). This successfuly allowed me to run the 4 library methods.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In particular, I had all the information necessary to make API calls: the URL and authentication information, obtained from the &lt;code&gt;getServerInfo()&lt;/code&gt; function.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;accessing-the-api&quot;&gt;Accessing the API&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Turns out that the credentials used for API calls were the same for all users, and hardcoded in the native library I had just decompiled. Therefore, using these credentials, it was possible for me to make any request to the API with unlimited permissions. For example, if I requested the information of a customer, I would get an output similar to the following:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;&lt;code class=&quot;language-json&quot; data-lang=&quot;json&quot;&gt;{
	&quot;CustomerAccount&quot;: {
		&quot;ID&quot;: &quot;78134aa1-5aff-4fb1-80dd-2a9ae1cf7200&quot;,
		&quot;Name&quot;: &quot;Gustavo Silva&quot;,
		&quot;Address&quot;: &quot;&quot;,
		&quot;City&quot;: &quot;Maia&quot;,
		&quot;Email&quot;: &quot;silva95gustavo@example.com&quot;,
		&quot;Password&quot;: &quot;my-ultra-unsafe-password&quot;,
		&quot;PostalCode&quot;: &quot;&quot;,
		&quot;FiscalNumber&quot;: 0,
		&quot;IdentificationNumber&quot;: &quot;&quot;,
		&quot;TIPCode&quot;: &quot;0&quot;,
		&quot;Phone&quot;: &quot;+351987654321&quot;,
		&quot;BillingInformationDetails&quot;: {
			&quot;ID&quot;: &quot;1ef88e57-c75b-4fe1-b12c-bcadc1808a00&quot;,
			&quot;Name&quot;: &quot;Gustavo Rocha da Silva&quot;,
			&quot;Address&quot;: &quot;R. Dr. Augusto Martins 101&quot;,
			&quot;City&quot;: &quot;Maia&quot;,
			&quot;PostalCode&quot;: &quot;1234-567&quot;,
			&quot;FiscalNumber&quot;: 123456789,
			&quot;CountryDetails&quot;: {
				&quot;Id&quot;: &quot;30b5fbdd-5044-4219-9ba3-fcfaf716d83d&quot;,
				&quot;Code&quot;: &quot;PT&quot;,
				&quot;Name&quot;: &quot;Portugal&quot;,
				&quot;InvoicerCode&quot;: &quot;PORTUGAL_PT&quot;
			}
		},
		&quot;CustomerPaymentMethod&quot;: {
			&quot;Name&quot;: &quot;Cartão de crédito/débito&quot;,
			&quot;RefCode&quot;: &quot;XXXXX&quot;,
			&quot;ThumbnailUrl&quot;: &quot;https://example.com/images/thumbnail.png&quot;,
			&quot;InfoToCustomer&quot;: &quot;Gustavo Rocha da Silva\r\n**** **** **** 1234\r\n10/2018&quot;
		}
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;aftermath&quot;&gt;Aftermath&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;By that time (less than a week since the public release) the app already had over 10 000 installs and it was possible to:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;View personal data from any user, including name, home address, last 4 digits of the credit card, phone number and fiscal number&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Read any user&amp;#8217;s password in &lt;strong&gt;plain-text&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Perform other actions allowed by the API (I did not investigate further)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The vulnerability was assigned the identifier &lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13342&quot;&gt;CVE-2018-13342&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Following a responsible disclosure model, I reported the vulnerability to the developers of the application. Timeline of events:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;29 June 2018 - Public release of Anda&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;4 July 2018 - Private vulnerability disclosure to vendor&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;7 July 2018 - Vendor acknowledgement&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;~11 July 2018 - Passwords no longer stored in plain-text&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;22 August 2018 - Communication of the vulnerability details to CERT.PT&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;9 September 2018 - New app version released using a safer API&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;23 October 2018 - Shutdown of the old vulnerable API&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</content><author><name></name></author><category term="Hack" /><category term="Anda" /><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/3010353/47465354-804f5c00-d7e4-11e8-8563-a36d0454488b.jpg" /><media:content medium="image" url="https://user-images.githubusercontent.com/3010353/47465354-804f5c00-d7e4-11e8-8563-a36d0454488b.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">A failed attempt at hacking SIGARRA, the management system of the University of Porto</title><link href="https://gustavosilva.me//blog/2018/08/12/A-failed-attempt-at-hacking-SIGARRA-the-management-system-of-the-University-of-Porto.html" rel="alternate" type="text/html" title="A failed attempt at hacking SIGARRA, the management system of the University of Porto" /><published>2018-08-12T00:00:00+00:00</published><updated>2018-08-12T00:00:00+00:00</updated><id>https://gustavosilva.me//blog/2018/08/12/A-failed-attempt-at-hacking-SIGARRA-the-management-system-of-the-University-of-Porto</id><content type="html" xml:base="https://gustavosilva.me//blog/2018/08/12/A-failed-attempt-at-hacking-SIGARRA-the-management-system-of-the-University-of-Porto.html">&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;SIGARRA is the Information System for the Aggregated Management of Resources and Academic Records of the University of Porto. It serves 30000+ students, as well as professors and other employees.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;As part of my work on my master&amp;#8217;s thesis, I sometimes consulted similar works from previous students, by accessing the list of previous dissertations of my course, available at &lt;a href=&quot;https://sigarra.up.pt/feup/pt/teses.lista_teses?p_curso=742&quot; class=&quot;bare&quot;&gt;https://sigarra.up.pt/feup/pt/teses.lista_teses?p_curso=742&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/44003144-29f40a86-9e46-11e8-8578-fa804c9c875d.png&quot; alt=&quot;List of previous dissertations&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. List of previous dissertations&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Each entry on the list contains the title of the document, the name of the student, some relevant dates and the name of the supervisor. On the right side of the page, a sidebar allows the user to filter the entries, change the sorting method, change the number of entries per page or export them to an Excel file. When you chose to change the ordering of the list a couple of parameters are added to the URL, one of them being &quot;p_ord_campo&quot;, which translates to &quot;order field parameter&quot; and defines the name of the field that will be considered for sorting. The options in the sidebar allow us to change this field to one of the following values:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;NOME (author&amp;#8217;s name)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;TITULO (document title)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;GRAU (type of degree)&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;However, this input field was not properly sanitized, which meant that it was possible to write malicious SQL code instead of those expected values, therefore performing a &lt;a href=&quot;https://www.owasp.org/index.php/SQL_Injection&quot;&gt;SQL Injection&lt;/a&gt; attack.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;strong&gt;But how did I know that the field was vulnerable and how could it be exploited?&lt;/strong&gt; A possible way of defining a query to provide the data displayed on the list of dissertations would be as follows:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;SELECT * FROM thesis ORDER BY TITULO ASC&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If, in the above query, we replace the word &lt;code&gt;TITULO&lt;/code&gt; by the name of a different field, the resulting page outputs the same list but sorted in a different manner. If the field is vulnerable and the input is not properly sanitized, it is possible to build a query that sorts the list in different ways depending on the output of a subquery:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;SELECT * FROM thesis ORDER BY
CASE WHEN (
  SELECT 1 FROM dual
) &amp;gt; 0
THEN
  NOME
ELSE
  TITULO
END&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The subquery &lt;code&gt;SELECT 1 FROM dual&lt;/code&gt; always returns a single row with value 1. Since 1 is greater than zero, the list of thesis gets sorted by the field NOME. Likewise, if we change the subquery to return the value 0, the list gets sorted by the field TITULO. Doing this test, it can be concluded that our SQL injected code is indeed being executed and that we have found a method of reading the value of any SQL statement we define, as long as it returns a binary value. Therefore, it should be possible to access sensitive data stored in SIGARRA&amp;#8217;s database, such as a personal e-mail adddress, by filling the &quot;p_ord_campo&quot; field with a string such as:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;CASE WHEN (
  SELECT personal_email FROM user_accounts WHERE user_code = 'up201304143'
) &amp;gt; 'a'
THEN
  NOME
ELSE
  TITULO
END&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;SIGARRA runs an Oracle Database. In Oracle SQL, the &lt;code&gt;&amp;gt;&lt;/code&gt; operator, when used with strings, returns true if the first string comes after the second one alphabetically. With this input, if the first char of the e-mail address of user &quot;up201304143&quot; has a higher value than the value of &quot;a&quot; in the &lt;a href=&quot;https://en.wikipedia.org/wiki/ASCII&quot;&gt;ASCII table&lt;/a&gt;, then the list of thesis gets sorted by the field NOME, otherwise it gets sorted by the field TITULO. If we repeat this process using chars other than &quot;a&quot; we can find out what is the value of the first char in the e-mail address that we want to read. Then, the process can be repeated by appending more chars to the string in order to fully read the user&amp;#8217;s personal e-mail address. Ultimately, this process can be automated by building a script that reads the whole field by performing a &lt;a href=&quot;https://en.wikipedia.org/wiki/Binary_search_algorithm&quot;&gt;binary search&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;additional-layer-of-protection&quot;&gt;Additional layer of protection&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;It turns out that I was unable to read any sensitive data from SIGARRA&amp;#8217;s database by using this method. In fact, many of my queries would result in a special access denied error:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/44003231-35eaee58-9e47-11e8-9744-80b3b7546942.png&quot; alt=&quot;Error being thrown for some of my queries&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 2. Error being thrown for some of my queries (translated and adapted)&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I believe this was caused by a second layer of protection in SIGARRA&amp;#8217;s system, a &lt;a href=&quot;https://en.wikipedia.org/wiki/Web_application_firewall&quot;&gt;Web Application Firewall&lt;/a&gt; (WAF) that was blocking many of my queries. In fact, a simple query such as the one above mentioned would fail, because the &lt;code&gt;WHERE&lt;/code&gt; clause is blocked by the firewall. Therefore, I needed to change my query to something that did not include specific terms, similarly to &lt;a href=&quot;https://gustavosilva.me/blog/2017/07/11/How-I-hacked-the-international-application-form-of-the-Barcelona-School-of-Informatics.html&quot;&gt;what I described in a previous post&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The main challenge for me to read a particular value from the database was to ensure that the subquery (inside the CASE statement) returned a single-row and single-column value, so that a comparison operator (such as &lt;code&gt;&amp;gt;&lt;/code&gt;) could be applied to it. To build such query, I had to:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Bypass the WAF&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Understand the structure of the database, in terms of table names and columns&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Ensure the result contains only one row&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Ensure the result contains only one column&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;First, to help circunventing the limitations imposed by the WAF, I built a non-comprehensive list of SQL commands, clauses, pseudocolumns and identifiers that were being blocked:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;ulist&quot;&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;avg()&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;count()&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;database_name&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;IN&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;max()&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;min()&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;rownum&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;SELECT CASE&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;sum()&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;table_name&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;UNION&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;WHERE&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So, to exploit the vulnerability, I had to build a query that extracted sensitive information without using any blocked word and returning a single row and column.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;But first, to understand the structure of a database we can list the entries of the &quot;all_tables&quot; table, which contains information on all the tables in the system. For example, to fetch the name of the first table the following query can be executed:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;SELECT table_name FROM all_tables WHERE rownum = 1&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The problem with this query is that it does not bypass the WAF due to the use of two blocked words: &lt;code&gt;table_name&lt;/code&gt; and &lt;code&gt;WHERE&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;filtering-results-without-the-where-clause&quot;&gt;Filtering results without the WHERE clause&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;strong&gt;But how to filter results without using the WHERE clause?&lt;/strong&gt; There might be a couple ways. One of them is to take advantage of a feature of Oracle databases called &lt;a href=&quot;https://docs.oracle.com/cd/B19306_01/server.102/b14200/queries003.htm&quot;&gt;Hierarchical Queries&lt;/a&gt;. Although these are aimed to be used with tables that contain hierarchical data, we can exploit these constructs to be able to filter the results based on a condition. Look at these two queries:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;SELECT owner FROM all_tables WHERE iot_name = 'CHNF$_CLAUSES'&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;SELECT owner FROM all_tables START WITH iot_name = 'CHNF$_CLAUSES' CONNECT BY 1 = 0&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;These queries return the same result, with the advantage that the latter is not blocked by the WAF. Feel free to check the documentation on &lt;a href=&quot;https://docs.oracle.com/cd/B19306_01/server.102/b14200/queries003.htm&quot;&gt;Hierarchical Queries&lt;/a&gt; for more information on how they work, but the general idea of the second query is that it traverses the results, considering the initial entries to be the ones that have &lt;code&gt;iot_name = 'CHNF$_CLAUSES'&lt;/code&gt; and then continuing the traversal to entries that match the condition &lt;code&gt;1 = 0&lt;/code&gt;. Since this condition is always false, only the root entry is returned.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This allows us to bypass the block on the &lt;code&gt;WHERE&lt;/code&gt; clause, yet still does not allow for an easy selection of a single row, because the &lt;code&gt;rownum&lt;/code&gt; pseudocolumn is also blocked by the WAF and cannot be used as a filter. Nevertheless, more complex conditions can be defined to ensure only one entry is returned, following a trial-and-error approach.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;reading-a-table-name-without-writing-table_name&quot;&gt;Reading a table name without writing &quot;table_name&quot;&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Being able to filter results and limiting them to one row gets us one step closer from exploiting this SQL injection vulnerability. But we still need to find the names of the tables in the database, although the WAF disallows queries containing the word &lt;code&gt;table_name&lt;/code&gt;. This means that we cannot directly select the column &lt;code&gt;table_name&lt;/code&gt; from the table &lt;code&gt;all_tables&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;To avoid this, one might try to select all columns (using the &lt;code&gt;*&lt;/code&gt; operator) instead of specifying the name of the table we want to fetch. However, this procedure violates one of the aforementioned requirements that forces us to build queries with a single-column output.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;What other options are available? One of the features of Oracle databases since version 11g is &lt;a href=&quot;https://www.oracle.com/technetwork/articles/sql/11g-pivot-097235.html&quot;&gt;pivoting and unpivoting&lt;/a&gt;. In particular, pivoting can be used to select from a table excluding some columns, &lt;a href=&quot;https://stackoverflow.com/a/33220953/1568560&quot;&gt;as demonstrated in a stack overflow post&lt;/a&gt;. This means that it might be possible to select all columns from &lt;code&gt;all_tables&lt;/code&gt; but excluding all columns except &lt;code&gt;table_name&lt;/code&gt;. This would result in only the &lt;code&gt;table_name&lt;/code&gt; column being selected. The syntax of a &lt;code&gt;PIVOT&lt;/code&gt; is something like:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;SELECT * FROM
  table
PIVOT
(
  aggregate_function(column)
  FOR column
  IN ( expr1, expr2, ... expr_n) | subquery
)&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;However, although the &lt;code&gt;PIVOT&lt;/code&gt; clause is accepted by the WAF, the &lt;code&gt;IN&lt;/code&gt; operator is blocked. Since we need the &lt;code&gt;IN&lt;/code&gt; operator to match the required syntax for pivoting, &lt;strong&gt;it is not possible to use this method to bypass the WAF&lt;/strong&gt; and read the &lt;code&gt;table_name&lt;/code&gt; column.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;the-end&quot;&gt;The end&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Having failed at bypassing the WAF using the techniques mentioned above (and others), I was preparing to give up on exploiting this vulnerability. Yet, some time later, I decided to give it another shot and see if I could come up with new ideas to circunvent the WAF. To my surprise, this time all of my queries were failing, including the ones that used to work before&amp;#8230;&amp;#8203; It seemed like the issue had been fixed!&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Anyway, I emailed the developers behind SIGARRA with details on the vulnerability and they confirmed me that they had seen my intrusion attempts in their logs and quickly solved the issue. Therefore I was unable to exploit the system, but happy to know that my academic data is well secured.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</content><author><name></name></author><category term="Hack" /><category term="SIGARRA" /><category term="SQL_Injection" /></entry><entry><title type="html">How I hacked the international application form of the Barcelona School of Informatics</title><link href="https://gustavosilva.me//blog/2017/07/11/How-I-hacked-the-international-application-form-of-the-Barcelona-School-of-Informatics.html" rel="alternate" type="text/html" title="How I hacked the international application form of the Barcelona School of Informatics" /><published>2017-07-11T00:00:00+00:00</published><updated>2017-07-11T00:00:00+00:00</updated><id>https://gustavosilva.me//blog/2017/07/11/How-I-hacked-the-international-application-form-of-the-Barcelona-School-of-Informatics</id><content type="html" xml:base="https://gustavosilva.me//blog/2017/07/11/How-I-hacked-the-international-application-form-of-the-Barcelona-School-of-Informatics.html">&lt;div id=&quot;preamble&quot;&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;As part of the incoming admission procedure of my Erasmus destination institution, &lt;a href=&quot;http://www.fib.upc.edu/&quot;&gt;Barcelona School of Informatics&lt;/a&gt;, an application form had to be filled with information about me and the courses I planned on attending.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Therefore, there is a section of the form where students can choose from a drop-down list the courses they want to attend. When the &quot;Add&quot; button is pressed, an asynchronous request is sent to the server and the course gets added to the table.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350581-1181f43c-80a9-11e8-86ab-7817de0ff969.png&quot; alt=&quot;International application form&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. International application form&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Unfortunately for me, I noticed one of my courses was not listed because it was not being offered for exchange students. So I replaced the HTML of the drop-down in order to include that specific course that was missing and was able to add it to my list of subjects, since there was no further server-side validation taking place. Obviously, I ended up deleting it, because I did not want someone to later tell me I could not enroll in that course.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;finding-the-vulnerability&quot;&gt;Finding the vulnerability&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Eventually, I tested the system for &lt;a href=&quot;https://www.owasp.org/index.php/SQL_Injection&quot;&gt;SQL Injection&lt;/a&gt; by adding an apostrophe to the initials of the subject name:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350582-11b3b666-80a9-11e8-9bf1-95e3ea301625.png&quot; alt=&quot;SQL Injection vulnerability test&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 2. SQL Injection vulnerability test&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Indeed, the system was vulnerable to SQL Injection attacks. The server receives the list of courses selected and replies with the HTML code of the new drop-down, without the already selected courses. The client sends the list of currently selected courses as a string made of their initials separated by commas (e.g. &lt;code&gt;AGT,AM,AMMM&lt;/code&gt;), but that string was not being properly escaped before being sent to the database.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;exploiting-the-vulnerability&quot;&gt;Exploiting the vulnerability&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I am not very experienced with this kind of attacks, but one way of performing them (after finding the vulnerability) is to use the &lt;a href=&quot;https://www.w3schools.com/sql/sql_union.asp&quot;&gt;UNION operator&lt;/a&gt; to join the already existing SELECT statement with a new SELECT statement written by the exploiter. The challenge is to craft a statement that is similar to the original one, since it must contain the same amount of columns and with the same type.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If the number of columns in my test string doesn&amp;#8217;t match the number of columns in the original statement, the database will throw the following error:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;literalblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;ORA-01789: query block has incorrect number of result columns.&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Therefore, one way of finding the right amount of columns and their types is by trial and error (&lt;a href=&quot;https://websec.ca/kb/sql_injection#MySQL_Tables_And_Columns&quot;&gt;but there are faster methods&lt;/a&gt;). Fortunately, in this specific case, the whole query was being output to the user, which meant that I could easily count the number of columns and find their types. The original query returned a total of 6 columns with types where the 1st and 4th were numbers and the rest were strings.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Now that I had information about the original query, I proceeded with my attempt to do an SQL Injection attack taking advantage of the UNION operator. This was my input string:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;literalblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;A' UNION
    SELECT
    a1.codi_assig,
    a1.sigles,
    a1.nom,
    a1.credits,
    a1.titulacio,
    a2.quadri
    FROM rriiassig--&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;My objective with this string was to replicate the original query, selecting the exact same columns, just to test if everything would work properly. The last two hyphens are used to start an inline comment, which means that the rest of the original query that follows them would be ignored. However, the database replied with the following error:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;literalblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;ORA-00923 FROM keyword not found where expected&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;After analyzing the query, I noticed that my string was being changed before being sent to the database:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;literalblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;A' UNION
    SELECT a1.codi_assig' AND sigles!='
    a1.sigles' AND sigles!='
    a1.nom' AND sigles!='
    a1.credits' AND sigles!='
    a1.titulacio' AND sigles!='
    a2.quadri
    FROM rriiassig--&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Wherever my input had a comma character, it would be replaced by the string &lt;code&gt;' AND sigles !='&lt;/code&gt;. As mentioned above, the normal user input would be a list of subjects separated by commas, so the idea of replacing the commas by such string was to select only the subjects with &lt;em&gt;sigles&lt;/em&gt; (initials) different to the ones in the input list. The result of this selection would then be the content of the new drop-down list, where the user could continue adding other courses.
This meant that my string could not contain any commas, as these were being replaced by a different text.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;strong&gt;But how to do a SQL SELECT query for 6 columns without using a comma to separate the different fields?&lt;/strong&gt; This is possible by cross joining 6 different subqueries where each of those subqueries returns only one column, such as:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;literalblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;A' UNION
    SELECT * FROM (SELECT 1 FROM rriiassig)
    CROSS JOIN (SELECT 'aaa' FROM rriiassig)
    CROSS JOIN (SELECT 'bbb' FROM rriiassig)
    CROSS JOIN (SELECT 4 FROM rriiassig)
    CROSS JOIN (SELECT 'ccc' FROM rriiassig)
    CROSS JOIN (SELECT 'Q1' FROM rriiassig) --&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I ran this query and&amp;#8230;&amp;#8203; Oops, the server went down for a couple minutes due to the huge size of my query (cross joining 6 tables). I should have filtered my query by applying a LIMIT to one or more fields. That&amp;#8217;s when I stopped my investigation and emailed the institution with information on the security exploit, so I still don&amp;#8217;t know if the vulnerability gave me access to the database of the international page only or if that database was also used in different locations for different purposes. They answered the day after:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;[&amp;#8230;&amp;#8203;] We&amp;#8217;ve reproduced the bug and looking at the source code, all the application form application uses parametrized SQL except the subject part! [&amp;#8230;&amp;#8203;]&quot;&lt;/p&gt;
&lt;/div&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; Jaume Moral Ros - Facultat d'Informàtica de Barcelona
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The issue was then fixed in less than a week.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</content><author><name></name></author><category term="Hack" /><category term="FIB" /><category term="SQL_Injection" /><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/3010353/42350813-fa70864a-80a9-11e8-9299-446b256dbc86.png" /><media:content medium="image" url="https://user-images.githubusercontent.com/3010353/42350813-fa70864a-80a9-11e8-9299-446b256dbc86.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">How I hacked the website of CDUP, the Sports Center of the University of Porto</title><link href="https://gustavosilva.me//blog/2017/07/03/How-I-hacked-the-website-of-CDUP-the-Sports-Center-of-the-University-of-Porto.html" rel="alternate" type="text/html" title="How I hacked the website of CDUP, the Sports Center of the University of Porto" /><published>2017-07-03T00:00:00+00:00</published><updated>2017-07-03T00:00:00+00:00</updated><id>https://gustavosilva.me//blog/2017/07/03/How-I-hacked-the-website-of-CDUP-the-Sports-Center-of-the-University-of-Porto</id><content type="html" xml:base="https://gustavosilva.me//blog/2017/07/03/How-I-hacked-the-website-of-CDUP-the-Sports-Center-of-the-University-of-Porto.html">&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;While checking the gym prices at CDUP, my friend &lt;a href=&quot;http://diogomoura.me&quot;&gt;Diogo Moura&lt;/a&gt; noticed something unusual: a small square on the bottom-left corner that when clicked would display a bar sticking to the bottom of the screen.
I didn&amp;#8217;t capture a screenshot so I recreated the page in Photoshop:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350758-be761614-80a9-11e8-901c-5e379a5d8e39.png&quot; alt=&quot;Homepage&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. Homepage&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Diogo is a good guy so he stopped there.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I started investigating that bar and noticed it was the &lt;a href=&quot;http://phpdebugbar.com/&quot;&gt;PHP Debug Bar&lt;/a&gt;, useful for debugging purposes during development. It contains some tabs with multiple information about everything that happens in the website. One of the features it provides is a list of the latest HTTP requests made by every user on the website:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350574-00b2783e-80a9-11e8-82a1-94794205a59f.png&quot; alt=&quot;Request list&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 2. Request list&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Obviously, this is a big security issue, since I could trace the actions in the website of whoever I wanted. Some of the entries in that list had the text &quot;/login&quot; in the URL field and &quot;POST&quot; in the method field, meaning that they were related to submissions of the administrator login form. By clicking that entry I was able to see all details of that specific request, including the username and the plaintext password that were sent in the body of the request:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;literalblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre&gt;{
   &quot;_token&quot;:&quot;YVOzlSSYcaEEkPF24AVNke2KsdvEUZedIwNtHyJo&quot;,
   &quot;username&quot;:&quot;Admin&quot;,
   &quot;password&quot;:&quot;XXXXXXXXXXXXXXXX&quot;
}&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So I went to the &lt;a href=&quot;http://cdup.up.pt/admin&quot;&gt;administrator login form&lt;/a&gt; and successfully logged in with the credentials I had just stolen. Now I had access to the backoffice of the whole website and I could manage users, edit content, etc.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350573-00843f64-80a9-11e8-9b70-a8b23d565e33.png&quot; alt=&quot;Editing an entry in the backoffice&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 3. Editing an entry in the backoffice&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The issue was reported to CDUP and was fixed quickly by removing the PHP Debug Bar.&lt;/p&gt;
&lt;/div&gt;</content><author><name></name></author><category term="Hack" /><category term="CDUP" /><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/3010353/42350572-00563f06-80a9-11e8-8d94-9fa69d82b758.png" /><media:content medium="image" url="https://user-images.githubusercontent.com/3010353/42350572-00563f06-80a9-11e8-8d94-9fa69d82b758.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">How I accidentally hacked the e-learning platform of the University of Porto (MoodleUP)</title><link href="https://gustavosilva.me//blog/2017/06/30/How-I-accidentally-hacked-the-e-learning-platform-of-the-University-of-Porto-MoodleUP.html" rel="alternate" type="text/html" title="How I accidentally hacked the e-learning platform of the University of Porto (MoodleUP)" /><published>2017-06-30T00:00:00+00:00</published><updated>2017-06-30T00:00:00+00:00</updated><id>https://gustavosilva.me//blog/2017/06/30/How-I-accidentally-hacked-the-e-learning-platform-of-the-University-of-Porto-MoodleUP</id><content type="html" xml:base="https://gustavosilva.me//blog/2017/06/30/How-I-accidentally-hacked-the-e-learning-platform-of-the-University-of-Porto-MoodleUP.html">&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;moodleup&quot;&gt;MoodleUP&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Moodle is a learning platform designed to provide educators, administrators and learners with a single robust, secure and integrated system to create personalised learning environments.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Moodle is widely used in the University of Porto and one of its main uses envolves carrying out digital exams to evaluate the knowledge of students.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;moodlewatcher&quot;&gt;MoodleWatcher&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;In order to avoid cheating in exams, a tool named MoodleWatcher was developed. According to the authors:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;MoodleWatcher consists of a front-end web application that shares code with Moodle in relation to the use of database access. [&amp;#8230;&amp;#8203;]&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The main purpose of the tool is to provide a simple and efficient monitoring method to be used by teachers in order to assure them of the integrity of the tests and exams carried out using Moodle.&lt;/p&gt;
&lt;/div&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; MATOS, Rodolfo; TORRÃO, Sofia; VIEIRA, Tito Carlos S. Moodlewatcher: detection and prevention of fraud when using Moodle quizzes. In: Proceedings of INTED2012 Conference. 2012.
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://sigarra.up.pt/reitoria/pt/pub_geral.show_file?pi_gdoc_id=336206&quot;&gt;There is a whole paper explaining the MoodleWatcher tool&lt;/a&gt;, so I won&amp;#8217;t be listing here all the features of the system.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;the-story&quot;&gt;The story&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;&lt;strong&gt;Procrastinate:&lt;/strong&gt; Delay or postpone action; put off doing something.&lt;/p&gt;
&lt;/div&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; Oxford Dictionary
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;During a study-procrastinate session, I remembered a previously taken Moodle exam where one of the vigilant professors announced something like &quot;Do not cheat during the exam, your actions are being monitored&quot;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This made me slightly curious. Was the professor really speaking the truth? Does Moodle have a feature for monitoring students' actions during quizzes? After a bit of research I found the page of MoodleWatcher. And by searching the system for some time I realized that the professor was indeed telling the true, most of the actions were being monitored.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;MoodleWatcher generates a report for each quiz, listing all unallowed and possibly dangerous actions made by students.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350533-e0ef8474-80a8-11e8-818c-1645355e2550.png&quot; alt=&quot;MoodleWatcher dashboard&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 1. MoodleWatcher dashboard&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;During my procrastination, I tried exploiting the system with a basic &lt;a href=&quot;https://en.wikipedia.org/wiki/SQL_injection&quot;&gt;SQL injection attack&lt;/a&gt; on the quiz ID, but the system was protected against such attacks. So I started trying random quiz IDs to see exactly what kind of actions were being tracked. While doing this, I noticed that some of the pages were throwing some strange errors from the Moodle platform and the whole error page from Moodle was being displayed. I am sorry, but I did not capture a screenshot for this.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Eventually I gave up on hacking MoodleWatcher and went back to Moodle, ready to restart my studying session. That&amp;#8217;s when I noticed something strange: instead of being logged in my normal account, I was logged in as a user named with a single dot (&quot;.&quot;).&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350536-e144e36a-80a8-11e8-96f7-8f58e82fdb80.jpg&quot; alt=&quot;Logged in as the dot user&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 2. Logged in as the dot user&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I pressed the &quot;Save changes&quot; button in the Edit Profile page, without changing any settings, and got taken to my profile page:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350534-e119adb2-80a8-11e8-8456-96cadccc0a81.jpg&quot; alt=&quot;Own profile&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 3. Viewing own profile page&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;All of a sudden I was no longer myself nor the dot user, I was the &lt;strong&gt;Admin User&lt;/strong&gt;. And this meant that I had full access to MoodleUP, including the possibility of managing accounts, viewing hidden quizzes, downloading a full backup, changing grades, etc.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sect2&quot;&gt;
&lt;h3 id=&quot;the-vulnerability&quot;&gt;The vulnerability&lt;/h3&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So what exactly allowed me to gain administrator access to MoodleUP? And what does MoodleWatcher have to do with it?
In fact, there was an interesting security vulnerability in MoodleWatcher that allowed anyone to accidentally perform a &lt;a href=&quot;https://en.wikipedia.org/wiki/Session_hijacking&quot;&gt;session hijacking attack&lt;/a&gt;.
When something went wrong while displaying the report, the whole Moodle error page was being shown to the user. Unfortunately, I did not capture a screenshot for this, so I fired up Photoshop and tried to recreate it from memory:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;imageblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;img src=&quot;https://user-images.githubusercontent.com/3010353/42350537-e17026e2-80a8-11e8-8f81-6157c1e27639.jpg&quot; alt=&quot;Error output example&quot;&gt;
&lt;/div&gt;
&lt;div class=&quot;title&quot;&gt;Figure 4. Error output example&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Clearly, the dot user was the account used by the system to fetch all information from Moodle. Then, in case of error, the whole error page was being redirected to the user.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Despite not being the safest and most beautiful solution, it did work well as a way of outputting errors, which in the end is what matters. The problem was that the body of the HTTP request was not the only data being redirected to the user. &lt;strong&gt;The HTTP headers were being redirected too! And this includes the &lt;em&gt;Set-Cookie&lt;/em&gt; header with the session token.&lt;/strong&gt; That&amp;#8217;s the reason why after going back to MoodleUP I was logged in as the dot user.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;But why did pressing the &quot;Save&quot; button on the Edit Profile page convert me from the dot user to the Admin User of Moodle? I&amp;#8217;m not sure, but I believe they actually are the same account. For some reason, the user name seems to change depending on the active language: &quot;.&quot; in Portuguese and &quot;Admin User&quot; in English.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sect1&quot;&gt;
&lt;h2 id=&quot;aftermath&quot;&gt;Aftermath&lt;/h2&gt;
&lt;div class=&quot;sectionbody&quot;&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;The issue was reported to the developers behind MoodleWatcher and got solved in a couple days. The fix was simple: redirect only the HTTP body instead of sending also the headers.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Eventually, another layer of protection was added by implementing HTTP Basic Authentication to the whole MoodleWatcher platform.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</content><author><name></name></author><category term="Hack" /><category term="Moodle" /><category term="UP" /><category term="MoodleUP" /><category term="MoodleWatcher" /><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://user-images.githubusercontent.com/3010353/42350532-e0c7df32-80a8-11e8-9e01-e556ad925857.jpg" /><media:content medium="image" url="https://user-images.githubusercontent.com/3010353/42350532-e0c7df32-80a8-11e8-9e01-e556ad925857.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Hello World!</title><link href="https://gustavosilva.me//blog/2017/06/29/Hello-World.html" rel="alternate" type="text/html" title="Hello World!" /><published>2017-06-29T00:00:00+00:00</published><updated>2017-06-29T00:00:00+00:00</updated><id>https://gustavosilva.me//blog/2017/06/29/Hello-World</id><content type="html" xml:base="https://gustavosilva.me//blog/2017/06/29/Hello-World.html">&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This is the first post of my new personal blog, where I will briefly present myself and the purpose of this blog.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;I am a Portuguese student currently enrolled in the Master in Informatics and Computer Engineering at the Faculty of Engineering of the University of Porto. You can find more information about me and what I do here: &lt;a href=&quot;http://gustavosilva.me&quot;&gt;gustavosilva.me&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;At the moment, I have some ideas ready to be published related to my recent &lt;em&gt;hacktivities&lt;/em&gt;. After that, I will either let it die or write about whatever crosses my mind.&lt;/p&gt;
&lt;/div&gt;</content><author><name></name></author><category term="Blog" /><category term="Hello_World" /><category term="Hello" /></entry></feed>