<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/new-blog/assets/css/style.css">
<title>How I hacked Anda, the public transportation app of Porto (CVE-2018-13342)</title>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>How I hacked Anda, the public transportation app of Porto (CVE-2018-13342) | Gustavo Silva’s Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="How I hacked Anda, the public transportation app of Porto (CVE-2018-13342)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="My personal blog." />
<meta property="og:description" content="My personal blog." />
<link rel="canonical" href="//new-blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html" />
<meta property="og:url" content="//new-blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html" />
<meta property="og:site_name" content="Gustavo Silva’s Blog" />
<meta property="og:image" content="https://user-images.githubusercontent.com/3010353/47465354-804f5c00-d7e4-11e8-8563-a36d0454488b.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-23T00:00:00+00:00" />
<script type="application/ld+json">
{"description":"My personal blog.","image":"https://user-images.githubusercontent.com/3010353/47465354-804f5c00-d7e4-11e8-8563-a36d0454488b.jpg","@type":"BlogPosting","url":"//new-blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html","headline":"How I hacked Anda, the public transportation app of Porto (CVE-2018-13342)","dateModified":"2018-10-23T00:00:00+00:00","datePublished":"2018-10-23T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"//new-blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
</head>

<body>
  <main class="container">
    <section class="about">
      <a href="/"><img src="/new-blog/assets/portfolio.png" alt="Gustavo Silva"></a>
      <h2 id="title">
        <a href="/">Gustavo Silva</a>
      </h2>
      <p class="tagline">Software Engineer</p>
      <ul class="social"><a href="https://github.com/silva95gustavo">
          <li>
            <i class="icon-github-circled"></i>
          </li>
        </a><a href="https://www.linkedin.com/in/silva95gustavo">
          <li>
            <i class="icon-linkedin-squared"></i>
          </li>
        </a><a href="https://twitter.com/silva95gustavo">
          <li>
            <i class="icon-twitter-squared"></i>
          </li>
        </a></ul><nav class="navigation">
        <ul>
          
          <li>
            <a href="/">Home</a>
          </li>
          
          <li>
            <a href="/blog">Blog</a>
          </li>
          
        </ul>
      </nav><p>&copy;
        2020</p></section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/new-blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html">
    <h2 class="post-title">How I hacked Anda, the public transportation app of Porto (CVE-2018-13342)</h2>
  </a>
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>Oct 23, 2018</div></div>
  <div class="post">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Andante is the multimodal transport ticket used in the city of Porto. On the 28th July 2018, the company behind Andante released the Anda app to allow the users of their public transport system to no longer need a physical card as ticket. Instead, by taking advantage of the GPS, NFC and BLE capabilities of modern smartphones, passengers now only need their mobile phones to travel.</p>
</div>
<div class="paragraph">
<p>I decided to observe the network packets sent by Anda to understand which kind of requests it was making to its API. Fot that, I used a packet sniffer app that acts as man-in-the-middle listening to all packets in both directions. Since all communications of Anda are performed using HTTPS, the packet sniffer uses a custom certificate for which it has both the public and private keys. Soon I realized this did not work, because Anda was programmed to perform certificate pinning, that is, being limited to a pre-defined certificate and not accepting others. One solution for this is to change the Anda app so that it allows a different certificate to be used. However, sometimes tweaking with the application code to bypass certificate pinning is not enough, if other protection mechanisms are implemented.</p>
</div>
<div class="paragraph">
<p>Instead of trying to obtain readable access to the network packets sent by Anda, I decided to decompile the .apk file and analyze the Java code to understand how it was communicating with the server API.</p>
</div>
<div class="paragraph">
<p>The application code was slightly obfuscated. Some of the methods were not implemented in Java but imported as a compiled native library with Java Native Interface (JNI). These methods were:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>loadNative() - initialization of the JNI environment.</p>
</li>
<li>
<p>verifyBeacon(byte[] b1, byte[] b2, int n) - did not investigate what this method does, probably related to BLE beacons.</p>
</li>
<li>
<p>getServerInfo() - returns an array with 3 hard-coded strings that were obfuscated in the compiled library: the base URL of the API, a username and a password.</p>
</li>
<li>
<p>getPersonalEncryptionkey() - returns a key based on the ANDROID_ID of the device.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to better understand the output of each of these functions, I analyzed the decompiled code of Anda and created a small Android application calling them in a similar manner and logging their output. This was the code of my app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">System.loadLibrary("native-lib");

boolean resultA = initializeNative();
Log.d("ANDA-DEBUG", resultA ? "true" : "false");

boolean resultB = verifyBeacon("".getBytes(), "".getBytes(), 1);
Log.d("ANDA-DEBUG", resultB ? "true" : "false");

String[] resultC = getServerInfo();
for (String s : resultC) {
    Log.d("ANDA-DEBUG", s + "");
}

String resultD = getPersonalEncryptionPass();
Log.d("ANDA-DEBUG", resultD + "");</code></pre>
</div>
</div>
<div class="paragraph">
<p>This attempt was not successful, as the first two functions returned "false" and the other two returned null values. Something was blocking my app from properly using the methods defined in the native library file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="disassembling">Disassembling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So I opened a disassembler and searched for what was causing this behavior. I noticed that all 4 functions made a call to another function named "isInitialized", immediately branching when false to a return statement with a zeroed return value. I figured this would most likely be the cause of the "false" and "null" outputs (zero, false and null are often represented the same way in machine code). Therefore, I had to understand why the "loadNative" method was not correctly initializing the JNI environment.</p>
</div>
<div class="paragraph">
<p>Looking at the initialization instructions, I found that it was getting the signature of my application and comparing it with a pre-defined value to detect tampering. If the signatures did not match, then the program would branch to the end and return 0. This was done with the CBZ instruction (Compare and Branch on Zero).</p>
</div>
<div class="listingblock">
<div class="title">Excert of the disassembled libnative library</div>
<div class="content">
<pre class="highlight"><code class="language-asm" data-lang="asm">BLX  __aeabi_memclr8
ADD  R6, SP, #0xF0+var_C4
MOV  R0, R6
BLX  j_sha256_init
MOV  R0, R6
MOV  R1, R8
MOV  R2, R5
BLX  j_sha256_update
MOV  R0, R6
MOV  R1, R10
BLX  j_sha256_final
LDR  R1, =(unk_13B13 - 0x3AF4)
MOV  R0, R10
MOVS R2, #0x20
ADD  R1, PC
BLX  memcmp <b class="conum">(1)</b>
CBZ  R0, loc_3B24</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>'memcmp': function of the C library that compares two regions of memory of the same size and returns 0 if they are equal</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In order to make my app bypass this verification, I patched the binary code so that the CBZ instruction was replaced by a CBNZ (Compare and Branch on Non-Zero). This successfuly allowed me to run the 4 library methods.</p>
</div>
<div class="paragraph">
<p>In particular, I had all the information necessary to make API calls: the URL and authentication information, obtained from the <code>getServerInfo()</code> function.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="accessing-the-api">Accessing the API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Turns out that the credentials used for API calls were the same for all users, and hardcoded in the native library I had just decompiled. Therefore, using these credentials, it was possible for me to make any request to the API with unlimited permissions. For example, if I requested the information of a customer, I would get an output similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
	"CustomerAccount": {
		"ID": "78134aa1-5aff-4fb1-80dd-2a9ae1cf7200",
		"Name": "Gustavo Silva",
		"Address": "",
		"City": "Maia",
		"Email": "silva95gustavo@example.com",
		"Password": "my-ultra-unsafe-password",
		"PostalCode": "",
		"FiscalNumber": 0,
		"IdentificationNumber": "",
		"TIPCode": "0",
		"Phone": "+351987654321",
		"BillingInformationDetails": {
			"ID": "1ef88e57-c75b-4fe1-b12c-bcadc1808a00",
			"Name": "Gustavo Rocha da Silva",
			"Address": "R. Dr. Augusto Martins 101",
			"City": "Maia",
			"PostalCode": "1234-567",
			"FiscalNumber": 123456789,
			"CountryDetails": {
				"Id": "30b5fbdd-5044-4219-9ba3-fcfaf716d83d",
				"Code": "PT",
				"Name": "Portugal",
				"InvoicerCode": "PORTUGAL_PT"
			}
		},
		"CustomerPaymentMethod": {
			"Name": "Cartão de crédito/débito",
			"RefCode": "XXXXX",
			"ThumbnailUrl": "https://example.com/images/thumbnail.png",
			"InfoToCustomer": "Gustavo Rocha da Silva\r\n**** **** **** 1234\r\n10/2018"
		}
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="aftermath">Aftermath</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By that time (less than a week since the public release) the app already had over 10 000 installs and it was possible to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>View personal data from any user, including name, home address, last 4 digits of the credit card, phone number and fiscal number</p>
</li>
<li>
<p>Read any user&#8217;s password in <strong>plain-text</strong></p>
</li>
<li>
<p>Perform other actions allowed by the API (I did not investigate further)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The vulnerability was assigned the identifier <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13342">CVE-2018-13342</a>.</p>
</div>
<div class="paragraph">
<p>Following a responsible disclosure model, I reported the vulnerability to the developers of the application. Timeline of events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>29 June 2018 - Public release of Anda</p>
</li>
<li>
<p>4 July 2018 - Private vulnerability disclosure to vendor</p>
</li>
<li>
<p>7 July 2018 - Vendor acknowledgement</p>
</li>
<li>
<p>~11 July 2018 - Passwords no longer stored in plain-text</p>
</li>
<li>
<p>22 August 2018 - Communication of the vulnerability details to CERT.PT</p>
</li>
<li>
<p>9 September 2018 - New app version released using a safer API</p>
</li>
<li>
<p>23 October 2018 - Shutdown of the old vulnerable API</p>
</li>
</ul>
</div>
</div>
</div>
  </div><div id="disqus_thread" style="margin-top:25px"></div>
  <script>
    var disqus_config = function () {
      this.page.url = '//new-blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html';
      this.page.identifier = '//new-blog/2018/10/23/How-I-hacked-Anda-the-public-transportation-app-of-Porto-CVE-2018-13342.html';
    };
    (function () {
      var d = document, s = d.createElement('script');
      s.src = 'https://silva95gustavo.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
      powered by Disqus.</a></noscript></div>

    </section>
  </main><script async src="https://www.googletagmanager.com/gtag/js?id=UA-70940481-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-70940481-1');
  </script>
</body>

</html>
